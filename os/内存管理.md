# 内存管理

## 虚拟内存技术

对于编程人员来说，实际上是不怎么关心内存问题的，对于Java、Python、JavaScript等动态类型语言来说更是如此，自动内存回收机制的引入使得这类语言的使用者几乎不用关心内存问题；即使对于编译型语言C/C++来说，需要关心的也仅仅是内存的申请和释放。总的来说，让编程人员(设计实现操作系统的除外)不用关心数据以及代码被放在了物理内存的哪个地址，并且可以简单的认为程序独占内存，这就是虚拟内存技术。

另外虚拟内存技术还让进程可以申请到的内存大小可以超过剩余物理内存限制。比如在 32 位系统下进程占用的内存空间为4G，在只有 256MB 物理内存剩余时可以申请1G大小的内存空间，这也是虚拟内存技术的实现。

总结一下，虚拟内存技术的特点：

1. 简化编程模型，让编程人员无需关心内存管理，提高开发效率
2. 提供内存隔离机制，让每个进程逻辑上都可以独享整个内存空间

## 虚拟内存的实现

虚拟内存技术提供了逻辑的抽象，但最终的数据和代码必然还是存放在物理内存上的，那么虚拟内存的核心就是要实现逻辑地址到物理地址的映射了。虚拟内存技术对内存进行离散管理分配，包括：分页式管理、分段式管理、段页式管理，将程序代码和数据进行按照固定大小进行划分，允许将程序代码分多次调入内存而非一次性装入内存。

### 分页式管理

将内存按照页进行均分，以页为单位在内存中进行换入和换出。

1. 页表：为了便于在内存中找到进程的每个页面所对应的物理块，系统为每个进程建立一张页表，记录页面在内存中对应的物理块号，页表一般存放在内存中。在配置了页表后，进程执行时，通过查找该表即可找到每页在内存中中的物理块号。
2. 页：进程中的块称为页，内存中的块称为页框。外存也以同样单位划分，直接称为块。进程在执行时需要申请主存空间，就是要为每个页面分配主存中的可用页框，这就产生了页和页框的一一对应。为了方便地址转换，页面大小应是 2 的整数幂（Linux默认一页大小是 4KB）。同时页面大小应当适中。如果页面太小，会是进程的页面数过多，这样**页表**就过长，占用大量内存，而且也会增加硬件地址转换的开销，降低页面换入换出的效率。页面过大可能导致每个页面不能完全用满，降低内存利用率。所以页面的大小应该适中，考虑到空间效率和时间效率。

### 页面置换算法

* FIFO：按照队列的方式，先入队的先淘汰
* LRU：最近最常使用的保留，不常使用的淘汰